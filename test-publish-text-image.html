<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•æ–‡å­—+å›¾ç‰‡å‘å¸ƒåŠŸèƒ½</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        .publish-section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #fafafa;
            border-radius: 8px;
        }
        .publish-section h2 {
            color: #666;
            margin-bottom: 15px;
        }
        textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }
        .image-upload {
            margin-bottom: 10px;
        }
        #addImage {
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #addImage:hover {
            background-color: #45a049;
        }
        #imagePreview {
            display: none;
            margin-top: 10px;
        }
        .preview-item {
            position: relative;
            display: inline-block;
        }
        .preview-item img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 4px;
        }
        .preview-delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(255, 0, 0, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 14px;
            cursor: pointer;
            line-height: 1;
        }
        .visibility-options {
            display: flex;
            margin-bottom: 10px;
        }
        .visibility-option-simple {
            padding: 10px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }
        .visibility-option-simple.active {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        #publishBtn {
            padding: 10px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
        }
        #publishBtn:hover {
            background-color: #0b7dda;
        }
        .status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        .error {
            background-color: #ffebee;
            color: #c62828;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>æµ‹è¯•æ–‡å­—+å›¾ç‰‡å‘å¸ƒåŠŸèƒ½</h1>

        <!-- å‘å¸ƒæµ‹è¯•åŒº -->
        <div class="publish-section">
            <h2>å‘å¸ƒå†…å®¹</h2>
            <textarea id="postContent" placeholder="è¯·è¾“å…¥æ–‡å­—å†…å®¹..."></textarea>
            <div class="image-upload">
                <button id="addImage">æ·»åŠ å›¾ç‰‡</button>
                <input type="file" id="imageInput" accept="image/*" style="display: none;">
            </div>
            <div id="imagePreview"></div>
            <div class="visibility-options">
                <div class="visibility-option-simple active" data-duration="forever">å…¬å¼€</div>
                <div class="visibility-option-simple" data-duration="24h">24å°æ—¶åæ¶ˆå¤±</div>
            </div>
            <button id="publishBtn">å‘å¸ƒå†…å®¹</button>
            <div id="publishStatus"></div>
        </div>

        <!-- è°ƒè¯•åŒº -->
        <div class="publish-section">
            <h2>è°ƒè¯•ä¿¡æ¯</h2>
            <div id="debugInfo"></div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡å’ŒDOMå…ƒç´ 
        let postContent, publishBtn, visibilityOptions, imageInput, imagePreview;
        let uploadedImage = null;

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        window.addEventListener('load', function() {
            console.log('å‘å¸ƒé¡µé¢åŠ è½½å®Œæˆ');
            
            // è·å–DOMå…ƒç´ 
            postContent = document.getElementById('postContent');
            publishBtn = document.getElementById('publishBtn');
            visibilityOptions = document.querySelectorAll('.visibility-option-simple');
            imageInput = document.getElementById('imageInput');
            imagePreview = document.getElementById('imagePreview');
            
            console.log('DOMå…ƒç´ è·å–ç»“æœ:', {
                postContent: !!postContent,
                publishBtn: !!publishBtn,
                visibilityOptions: visibilityOptions.length,
                imageInput: !!imageInput,
                imagePreview: !!imagePreview
            });
            
            // æ›´æ–°è°ƒè¯•ä¿¡æ¯
            updateDebugInfo();
            
            // åˆå§‹åŒ–å¯è§æ€§é€‰é¡¹
            initVisibilityOptions();
            
            // åˆå§‹åŒ–å›¾ç‰‡ä¸Šä¼ 
            initImageUpload();
            
            // ç»‘å®šå‘å¸ƒæŒ‰é’®äº‹ä»¶
            publishBtn.addEventListener('click', publishPost);
            console.log('å‘å¸ƒæŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
            
            console.log('å‘å¸ƒé¡µé¢åˆå§‹åŒ–å®Œæˆ');
        });
        
        // æ›´æ–°è°ƒè¯•ä¿¡æ¯
        function updateDebugInfo() {
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.innerHTML = `
                <strong>å½“å‰çŠ¶æ€:</strong><br>
                - æ–‡å­—å†…å®¹: ${postContent ? postContent.value.length : 0} å­—ç¬¦<br>
                - å›¾ç‰‡æ•°é‡: ${uploadedImage ? 1 : 0}<br>
                - uploadedImage: ${uploadedImage ? 'å·²è®¾ç½®' : 'null'}<br>
                - é¢„è§ˆå›¾æ˜¾ç¤º: ${imagePreview ? imagePreview.style.display : 'æœªæ‰¾åˆ°'}
            `;
        }
        
        // åˆå§‹åŒ–å¯è§æ€§é€‰é¡¹
        function initVisibilityOptions() {
            if (visibilityOptions.length === 0) {
                console.warn('æ²¡æœ‰æ‰¾åˆ°å¯è§æ€§é€‰é¡¹');
                return;
            }
            
            // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªé€‰é¡¹
            visibilityOptions[0].classList.add('active');
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            visibilityOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // ç§»é™¤æ‰€æœ‰é€‰é¡¹çš„activeç±»
                    visibilityOptions.forEach(opt => opt.classList.remove('active'));
                    // ä¸ºå½“å‰ç‚¹å‡»çš„é€‰é¡¹æ·»åŠ activeç±»
                    this.classList.add('active');
                });
            });
        }
        
        // åˆå§‹åŒ–å›¾ç‰‡ä¸Šä¼ 
        function initImageUpload() {
            if (!imageInput || !imagePreview) {
                console.warn('å›¾ç‰‡ä¸Šä¼ ç›¸å…³å…ƒç´ æœªæ‰¾åˆ°');
                return;
            }
            
            // å›¾ç‰‡ä¸Šä¼ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('addImage').addEventListener('click', function() {
                imageInput.click();
            });
            
            imageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                // åˆ›å»ºå›¾ç‰‡é¢„è§ˆ
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageData = {
                        file: file,
                        src: e.target.result
                    };
                    
                    // å¦‚æœå·²ç»æœ‰å›¾ç‰‡ï¼Œæ›¿æ¢å®ƒ
                    if (uploadedImage) {
                        // ç§»é™¤æ—§çš„é¢„è§ˆé¡¹
                        imagePreview.innerHTML = '';
                    }
                    
                    uploadedImage = imageData;
                    createImagePreview(imageData);
                    
                    // æ›´æ–°è°ƒè¯•ä¿¡æ¯
                    updateDebugInfo();
                };
                reader.readAsDataURL(file);
                
                // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                imageInput.value = '';
            });
        }
        
        // åˆ›å»ºå›¾ç‰‡é¢„è§ˆ
        function createImagePreview(imageData) {
            // åˆ›å»ºé¢„è§ˆé¡¹
            const previewItem = document.createElement('div');
            previewItem.className = 'preview-item';
            
            // åˆ›å»ºå›¾ç‰‡å…ƒç´ 
            const img = document.createElement('img');
            img.src = imageData.src;
            img.alt = 'é¢„è§ˆå›¾ç‰‡';
            
            // åˆ›å»ºåˆ é™¤æŒ‰é’®
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'preview-delete-btn';
            deleteBtn.innerHTML = 'Ã—';
            
            // åˆ é™¤æŒ‰é’®äº‹ä»¶
            deleteBtn.addEventListener('click', function() {
                uploadedImage = null;
                previewItem.remove();
                imagePreview.style.display = 'none';
                
                // æ›´æ–°è°ƒè¯•ä¿¡æ¯
                updateDebugInfo();
            });
            
            // ç»„è£…é¢„è§ˆé¡¹
            previewItem.appendChild(img);
            previewItem.appendChild(deleteBtn);
            imagePreview.appendChild(previewItem);
            
            // æ˜¾ç¤ºé¢„è§ˆå®¹å™¨
            imagePreview.style.display = 'flex';
        }
        
        // å‘å¸ƒå¸–å­å‡½æ•°
        function publishPost() {
            console.log('========================================');
            console.log('å‘å¸ƒæŒ‰é’®è¢«ç‚¹å‡»ï¼Œå¼€å§‹å‘å¸ƒè¿‡ç¨‹');
            
            if (!postContent) {
                console.error('âŒ å†…å®¹è¾“å…¥æ¡†æœªæ‰¾åˆ°:', document.getElementById('postContent'));
                showStatus('è¯·è¾“å…¥å†…å®¹', 'error');
                return;
            }
            
            // è·å–å†…å®¹
            const content = postContent.value.trim();
            if (!content) {
                console.warn('âŒ å†…å®¹ä¸ºç©ºï¼Œå‘å¸ƒå¤±è´¥');
                showStatus('è¯·è¾“å…¥å†…å®¹', 'error');
                return;
            }
            
            // è·å–å½“å‰é€‰ä¸­çš„å¯è§æ€§é€‰é¡¹
            const selectedVisibility = document.querySelector('.visibility-option-simple.active');
            const visibilityDuration = selectedVisibility ? selectedVisibility.dataset.duration : 'forever';
            
            console.log('âœ… å‡†å¤‡å‘å¸ƒå†…å®¹:', content);
            console.log('âœ… å¯è§æ€§æ—¶é•¿:', visibilityDuration);
            
            // æ¨¡æ‹Ÿå‘å¸ƒå»¶è¿Ÿ
            setTimeout(function() {
                console.log('âœ… æ¨¡æ‹Ÿå‘å¸ƒå»¶è¿Ÿç»“æŸï¼Œå¼€å§‹å¤„ç†å‘å¸ƒ');
                
                try {
                    // åˆ›å»ºå¸–å­å¯¹è±¡
                    const post = {
                        id: Date.now(), // ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºå”¯ä¸€ID
                        content: content,
                        visibility: visibilityDuration,
                        createdAt: new Date().toISOString(), // ä¿å­˜å‘å¸ƒæ—¶é—´
                        isPublic: true, // åˆå§‹çŠ¶æ€ä¸ºå…¬å¼€
                        images: [] // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å›¾ç‰‡æ•°æ®
                    };
                    
                    console.log('âœ… åˆ›å»ºå¸–å­å¯¹è±¡:', post);
                    
                    // å¦‚æœæœ‰ä¸Šä¼ çš„å›¾ç‰‡ï¼Œæ·»åŠ åˆ°å¸–å­å¯¹è±¡ä¸­
                    if (uploadedImage) {
                        post.images.push({
                            src: uploadedImage.src,
                            name: uploadedImage.file.name,
                            type: uploadedImage.file.type
                        });
                        console.log('âœ… æ·»åŠ å›¾ç‰‡åˆ°å¸–å­:', post.images);
                    } else {
                        console.log('â„¹ï¸ æ²¡æœ‰ä¸Šä¼ å›¾ç‰‡');
                    }
                    
                    // æ¨¡æ‹Ÿä¿å­˜åˆ°localStorage
                    savePostToLocalStorage(post);
                    
                    console.log('âœ… å‘å¸ƒçš„å†…å®¹å·²æˆåŠŸä¿å­˜åˆ°localStorage');
                    
                    // ç¡®ä¿è¾“å…¥æ¡†å’Œé¢„è§ˆå›¾å·²æ¸…ç©ºåå†æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
                    // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿DOMæ›´æ–°å®Œæˆ
                    requestAnimationFrame(() => {
                        // å†æ¬¡ç¡®è®¤æ¸…ç©ºï¼ˆé˜²æ­¢å¼‚æ­¥é—®é¢˜ï¼‰
                        if (postContent) {
                            postContent.value = '';
                        }
                        if (imagePreview) {
                            imagePreview.innerHTML = '';
                            imagePreview.style.display = 'none';
                        }
                        // é‡ç½®ä¸Šä¼ å›¾ç‰‡å˜é‡
                        uploadedImage = null;
                        
                        // æ›´æ–°è°ƒè¯•ä¿¡æ¯
                        updateDebugInfo();
                        
                        // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
                        showStatus('å‘å¸ƒæˆåŠŸï¼è¾“å…¥æ¡†å’Œé¢„è§ˆå›¾å·²æ¸…ç©º', 'success');
                        
                        console.log('ğŸ‰ å‘å¸ƒè¿‡ç¨‹å®Œæˆï¼Œæ‰€æœ‰æ­¥éª¤æˆåŠŸï¼');
                    });
                    
                } catch (error) {
                    console.error('âŒ å‘å¸ƒè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
                    console.error('é”™è¯¯å †æ ˆ:', error.stack);
                    showStatus('å‘å¸ƒå¤±è´¥: ' + error.message, 'error');
                }
                
            }, 1000);
        }
        
        // ä¿å­˜å¸–å­åˆ°localStorage
        function savePostToLocalStorage(post) {
            console.log('å¼€å§‹ä¿å­˜å¸–å­åˆ°localStorage...');
            console.log('ä¿å­˜çš„å¸–å­å†…å®¹:', post);
            
            // ä¸ºå¸–å­æ·»åŠ userIdå­—æ®µï¼Œä½¿ç”¨å½“å‰ç”¨æˆ·ID
            post.userId = '000001'; // å½“å‰ç”¨æˆ·å›ºå®šä¸º000001
            console.log('æ·»åŠ userIdå:', post);
            
            // è·å–ç°æœ‰çš„å¸–å­
            const existingPosts = JSON.parse(localStorage.getItem('posts')) || [];
            console.log('ä¿å­˜å‰postsé•¿åº¦:', existingPosts.length);
            
            // æ·»åŠ æ–°å¸–å­
            existingPosts.push(post);
            console.log('æ·»åŠ åpostsé•¿åº¦:', existingPosts.length);
            
            // ä¿å­˜å›localStorage
            localStorage.setItem('posts', JSON.stringify(existingPosts));
            const savedPosts = JSON.parse(localStorage.getItem('posts'));
            console.log('postsä¿å­˜æˆåŠŸï¼Œå½“å‰é•¿åº¦:', savedPosts ? savedPosts.length : 'å¤±è´¥');
            
            // ä¿å­˜åˆ°userPostsï¼Œç”¨äºä¸ªäººä¸»é¡µçš„å‘å¸ƒå†å²
            const userPosts = JSON.parse(localStorage.getItem('userPosts')) || [];
            console.log('ä¿å­˜å‰userPostsé•¿åº¦:', userPosts.length);
            
            userPosts.push(post);
            console.log('æ·»åŠ åuserPostsé•¿åº¦:', userPosts.length);
            
            localStorage.setItem('userPosts', JSON.stringify(userPosts));
            const savedUserPosts = JSON.parse(localStorage.getItem('userPosts'));
            console.log('userPostsä¿å­˜æˆåŠŸï¼Œå½“å‰é•¿åº¦:', savedUserPosts ? savedUserPosts.length : 'å¤±è´¥');
            
            // æ›´æ–°homeFeedsæ•°ç»„ï¼Œç”¨äºé¦–é¡µä¿¡æ¯æµ
            const homeFeeds = JSON.parse(localStorage.getItem('homeFeeds')) || [];
            console.log('ä¿å­˜å‰homeFeedsé•¿åº¦:', homeFeeds.length);
            
            // åªæœ‰å…¬å¼€å¸–å­æ‰æ·»åŠ åˆ°homeFeeds
            if (post.isPublic) {
                homeFeeds.push(post);
                console.log('æ·»åŠ åhomeFeedsé•¿åº¦:', homeFeeds.length);
                
                // æŒ‰æ—¶é—´æ’åºï¼Œæœ€æ–°çš„åœ¨å‰é¢
                homeFeeds.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                localStorage.setItem('homeFeeds', JSON.stringify(homeFeeds));
                const savedHomeFeeds = JSON.parse(localStorage.getItem('homeFeeds'));
                console.log('homeFeedsä¿å­˜æˆåŠŸï¼Œå½“å‰é•¿åº¦:', savedHomeFeeds ? savedHomeFeeds.length : 'å¤±è´¥');
            } else {
                console.log('å¸–å­ä¸ºéå…¬å¼€ï¼Œä¸æ·»åŠ åˆ°homeFeeds');
            }
            
            console.log('å¸–å­ä¿å­˜åˆ°localStorageå®Œæˆ:', post);
        }
        
        // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
        function showStatus(message, type) {
            const statusDiv = document.getElementById('publishStatus');
            statusDiv.className = 'status ' + type;
            statusDiv.textContent = message;
        }
    </script>
</body>
</html>